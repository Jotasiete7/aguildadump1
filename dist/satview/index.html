<!DOCTYPE html>
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
margin: 0;
background: #0D0D0D;
font-family: 'Inter', sans-serif;
overflow: hidden;
display: flex;
height: 100vh;
}

/* SIDEBAR - Fixed Width */
.sidebar {
width: 280px;
height: 100vh;
background: #0D0D0D;
border-right: 1px solid #333;
display: flex;
flex-direction: column;
gap: 15px;
z-index: 1000;
overflow-y: auto;
padding: 20px;
flex-shrink: 0;
}

/* MAP CONTAINER - Flex Grow */
.map-container {
flex: 1;
height: 100vh;
position: relative;
}

#map {
width: 100%;
height: 100%;
background: #0e0e0e;
cursor: crosshair;
}

.glass-box {
background: rgba(13, 13, 13, 0.6);
border: 1px solid #333;
border-radius: 4px;
padding: 15px;
color: #E0E0E0;
}

.credits-box {
background: rgba(0, 0, 0, 0.8);
border: 1px solid #333;
border-radius: 4px;
padding: 10px;
text-align: center;
font-size: 10px;
color: #737373;
margin-top: auto;
}

/* FILTROS */
.filter-row {
display: flex;
align-items: center;
gap: 8px;
margin-bottom: 8px;
cursor: pointer;
font-size: 12px;
transition: opacity 0.2s;
color: #E0E0E0;
}

.filter-row:hover {
opacity: 0.8;
}

.f-icon {
width: 16px;
text-align: center;
}

/* COORD BOX */
.coord-box {
position: absolute;
bottom: 20px;
left: 20px;
z-index: 1000;
display: flex;
align-items: center;
gap: 5px;
background: rgba(13, 13, 13, 0.9);
backdrop-filter: blur(4px);
padding: 5px 10px;
border-radius: 4px;
border: 1px solid #B00000;
}

.coord-input {
background: transparent;
border: none;
color: #E0E0E0;
font-family: 'Inter', sans-serif;
font-size: 12px;
width: 100px;
outline: none;
}

.coord-icon {
cursor: pointer;
font-size: 14px;
color: #B00000;
}

/* MODAL */
#modal {
display: none;
position: absolute;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
background: #0D0D0D;
border: 1px solid #B00000;
padding: 20px;
z-index: 2000;
border-radius: 4px;
width: 300px;
box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
color: #E0E0E0;
}

.modal-header {
display: flex;
justify-content: space-between;
margin-bottom: 15px;
font-weight: bold;
font-size: 14px;
color: #B00000;
text-transform: uppercase;
letter-spacing: 1px;
}

.form-group {
margin-bottom: 15px;
}

.form-label {
display: block;
font-size: 11px;
color: #737373;
margin-bottom: 5px;
text-transform: uppercase;
}

.form-input,
.form-select {
width: 100%;
background: #1a1a1a;
border: 1px solid #333;
color: #E0E0E0;
padding: 8px;
border-radius: 2px;
box-sizing: border-box;
font-family: 'Inter', sans-serif;
font-size: 12px;
}

.form-input:focus,
.form-select:focus {
border-color: #B00000;
outline: none;
}

.range-wrapper {
display: flex;
flex-direction: column;
gap: 5px;
}

.range-value {
font-size: 11px;
color: #B00000;
text-align: right;
}

.btn-save {
background: #B00000;
color: #fff;
border: none;
padding: 8px 15px;
border-radius: 2px;
cursor: pointer;
font-size: 12px;
font-weight: bold;
text-transform: uppercase;
}

.btn-cancel {
background: transparent;
border: 1px solid #444;
color: #888;
padding: 8px 15px;
border-radius: 2px;
cursor: pointer;
font-size: 12px;
margin-right: 10px;
text-transform: uppercase;
}

.modal-actions {
display: flex;
justify-content: flex-end;
margin-top: 20px;
}

/* Zoom classes */
.zoom-0 .map-icon {
transform: scale(0.5);
}

.zoom-1 .map-icon {
transform: scale(0.7);
}

.zoom-2 .map-icon {
transform: scale(1);
}

.zoom-3 .map-icon {
transform: scale(1.2);
}

.zoom-4 .map-icon {
transform: scale(1.5);
}
</style>
</head>

<body>
    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="glass-box">
            <div
                style="font-weight:bold; font-size:10px; color:#666; margin-bottom:10px; text-transform:uppercase; letter-spacing:1px;">
                Layers</div>
            <label class="filter-row" style="color:#ffd700"><input type="checkbox" checked
                    onchange="toggleGroup('deeds_active')"><span class="f-icon">üè∞</span>Active Deeds</label>
            <label class="filter-row" style="color:#b0bec5"><input type="checkbox" checked
                    onchange="toggleGroup('deeds_fallen')"><span class="f-icon">üèöÔ∏è</span>History / Ruins</label>
            <div style="border-top:1px solid #333; margin:5px 0;"></div>
            <label class="filter-row"><input type="checkbox" checked onchange="toggleGroup('rift')"><span
                    class="f-icon">üåÄ</span>Rifts</label>
            <label class="filter-row"><input type="checkbox" checked onchange="toggleGroup('ores')"><span
                    class="f-icon">‚õèÔ∏è</span>Min√©rios</label>
            <label class="filter-row" style="color:#00e676"><input type="checkbox" checked
                    onchange="toggleGroup('botany')"><span class="f-icon">üå≤</span>Botany (Flora)</label>
            <label class="filter-row" style="color:#ff5252"><input type="checkbox" checked
                    onchange="toggleGroup('mobs')"><span class="f-icon">üêæ</span>Fauna</label>
        </div>
        <div class="glass-box" style="padding:8px;">
            <button onclick="exportarDados()"
                style="width:100%; background:transparent; border:1px dashed #B00000; color:#B00000; padding:5px; cursor:pointer; font-size:10px; border-radius: 4px; font-weight: bold;">üíæ
                Export Data (JSON)</button>
        </div>
        <div class="credits-box">Dev by <span class="guild-name">A GUILDA</span><br>Harmony Server ‚Ä¢ 2025</div>
    </div>

    <!-- MAP CONTAINER -->
    <div class="map-container">
        <div id="map"></div>

        <div class="coord-box">
            <input type="text" id="coordInput" class="coord-input" placeholder="X, Y (Enter)" autocomplete="off">
            <span class="coord-icon" onclick="focarInput()" title="Go to Coords">üìç</span>
        </div>
    </div>

    <!-- MODAL -->
    <div id="modal">
        <div class="modal-header">
            <span>üìç Add Marker</span>
            <span style="cursor:pointer; color:#666" onclick="fecharModal()">‚úï</span>
        </div>
        <div class="form-group">
            <label class="form-label">Category</label>
            <select id="inputType" class="form-select" onchange="atualizarFormulario()">
                <option value="deed">üè∞ Active Deed</option>
                <option value="ruin">üèöÔ∏è History / Ruin</option>
                <option value="tree">üå≤ Tree (Sprout)</option>
                <option value="bush">üåø Bush (Seedling)</option>
                <option value="rift">üåÄ Rift</option>
                <option value="lair">üêæ Fauna / Lair</option>
                <option value="unique">üê≤ Unique / Boss</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label" id="nameLabel">Name / Type</label>
            <input type="text" id="inputName" class="form-input" placeholder="Ex: North Village">
            <select id="selectTree" class="form-select" style="display:none">
                <option value="Apple tree">Apple tree</option>
                <option value="Birch tree">Birch tree</option>
                <option value="Cedar tree">Cedar tree</option>
                <option value="Cherry tree">Cherry tree</option>
                <option value="Chestnut tree">Chestnut tree</option>
                <option value="Fir tree">Fir tree</option>
                <option value="Lemon tree">Lemon tree</option>
                <option value="Linden tree">Linden tree</option>
                <option value="Maple tree">Maple tree</option>
                <option value="Oak tree">Oak tree</option>
                <option value="Olive tree">Olive tree</option>
                <option value="Orange tree">Orange tree</option>
                <option value="Pine tree">Pine tree</option>
                <option value="Walnut tree">Walnut tree</option>
                <option value="Willow tree">Willow tree</option>
            </select>
            <select id="selectBush" class="form-select" style="display:none">
                <option value="Blueberry bush">Blueberry bush</option>
                <option value="Camellia bush">Camellia bush</option>
                <option value="Grape bush">Grape bush</option>
                <option value="Hazelnut bush">Hazelnut bush</option>
                <option value="Lavender bush">Lavender bush</option>
                <option value="Lingonberry bush">Lingonberry bush</option>
                <option value="Oleander bush">Oleander bush</option>
                <option value="Raspberry bush">Raspberry bush</option>
                <option value="Rose bush">Rose bush</option>
                <option value="Thorn bush">Thorn bush</option>
            </select>
        </div>
        <div class="form-group" id="rangeGroup" style="display:none">
            <div class="range-wrapper">
                <label class="form-label" style="margin-bottom:10px">Forest Range</label>
                <input type="range" id="inputRange" class="range-slider" min="1" max="5" step="1" value="1"
                    oninput="atualizarRangeLabel(this.value)">
                <div class="range-value">Size: <span id="rangeLabel">1 (Small)</span></div>
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Description / Date</label>
            <input type="text" id="inputDesc" class="form-input" placeholder="Optional">
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="fecharModal()">Cancel</button>
            <button class="btn-save" onclick="salvarPonto()">Save Marker</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const MAP_SIZE = 4096;
        const SCALE_FACTOR = 1 / 16;

        L.CRS.Harmony = L.Util.extend({}, L.CRS.Simple, {
            transformation: new L.Transformation(SCALE_FACTOR, 0, SCALE_FACTOR, 0)
        });

        var map = L.map('map', {
            crs: L.CRS.Harmony,
            minZoom: 0,
            maxZoom: 4,
            zoomControl: false,
            maxBounds: [[0, 0], [MAP_SIZE, MAP_SIZE]]
        });

        L.control.zoom({
            position: 'topright'
        }).addTo(map);
        map.fitBounds([[0, 0], [MAP_SIZE, MAP_SIZE]]);

        var layerTerreno = L.tileLayer('tiles_terreno/{z}/{x}/{y}.png', {
            minZoom: 0, maxZoom: 4, tileSize: 256, noWrap: true, tms: false, bounds: [[0, 0], [MAP_SIZE, MAP_SIZE]]
        }).addTo(map);

        var layerTopo = L.tileLayer('tiles_topo/{z}/{x}/{y}.png', {
            minZoom: 0, maxZoom: 4, tileSize: 256, noWrap: true, tms: false, bounds: [[0, 0], [MAP_SIZE, MAP_SIZE]]
        });

        var editMode = false;
        var tempClickCoords = { x: 0, y: 0 };
        var inputFocado = false;

        const config = {
            'deed': { icon: 'üè∞', color: '#ffd700', group: 'deeds_active', label: 'Active' },
            'ruin': { icon: 'üèöÔ∏è', color: '#b0bec5', group: 'deeds_fallen', label: 'Ruin' },
            'rift': { icon: 'üåÄ', color: '#e040fb', group: 'rift', label: 'Rift' },
            'ore': { icon: '‚õèÔ∏è', color: '#90a4ae', group: 'ores', label: 'Ore' },
            'tree': { icon: 'üå≤', color: '#00e676', group: 'botany', label: 'Tree' },
            'bush': { icon: 'üåø', color: '#76ff03', group: 'botany', label: 'Bush' },
            'lair': { icon: 'üêæ', color: '#ff5252', group: 'mobs', label: 'Lair' },
            'unique': { icon: 'üê≤', color: '#ff1744', group: 'mobs', label: 'Unique' }
        };

        var dados = [];
        var layers = L.layerGroup().addTo(map);

        var filtrosAtivos = {
            deeds_active: true,
            deeds_fallen: true,
            rift: true,
            ores: true,
            botany: true,
            mobs: true
        };
        var tempMarker = null;

        function renderizarMapa(busca = "") {
            layers.clearLayers();

            dados.forEach(d => {
                let conf = config[d.cat] || { icon: 'üìç', color: '#fff', group: 'outros' };
                if (!filtrosAtivos[conf.group]) return;

                let nome = d.nome || d.item;
                if (busca && !(nome + " " + (d.desc || "")).toLowerCase().includes(busca.toLowerCase())) return;

                if (d.escala) {
                    let radiuses = [20, 45, 70, 95, 120];
                    let raio = radiuses[d.escala - 1] || 20;

                    L.circle([d.y, d.x], {
                        color: conf.color,
                        fillColor: '#fff',
                        fillOpacity: 0.15,
                        opacity: 0.6,
                        radius: raio,
                        weight: 1,
                        dashArray: '2, 4'
                    }).addTo(layers);
                }

                let htmlIcon = `<span style="color:${conf.color};">${conf.icon}</span>`;

                let m = L.marker([d.y, d.x], {
                    icon: L.divIcon({
                        className: 'map-icon',
                        html: htmlIcon,
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    })
                });

                m.bindTooltip(`<span>${conf.icon} ${nome}</span>`, {
                    direction: 'top',
                    offset: [0, -10],
                    className: 'custom-tooltip',
                    opacity: 1
                });

                m.bindPopup(`<div style="text-align:center; font-family:sans-serif; min-width:150px">
                    <strong style="color:${conf.color}; font-size:14px">${conf.icon} ${nome}</strong><br>
                    <span class="badge" style="background:${conf.color}; margin: 5px 0; display:inline-block">${conf.label}</span>
                    <p style="margin:5px 0; font-size:12px; color:#ccc">${d.desc || ''}</p>
                    <div style="background:#222; color:#666; font-size:10px; padding:2px; border-radius:4px; margin-top:5px">X:${d.x} Y:${d.y}</div>
                </div>`);

                m.addTo(layers);
            });
        }

        const coordInput = document.getElementById('coordInput');

        coordInput.addEventListener('focus', () => { inputFocado = true; });
        coordInput.addEventListener('blur', () => { inputFocado = false; });

        coordInput.addEventListener('keyup', function (e) {
            if (e.key === 'Enter') {
                let val = this.value.trim();
                let x, y;

                if (/^\d{8}$/.test(val)) {
                    x = parseInt(val.substring(0, 4));
                    y = parseInt(val.substring(4, 8));
                } else {
                    let parts = val.replace(/[^0-9]/g, ' ').trim().split(/\s+/);
                    if (parts.length >= 2) {
                        x = parseInt(parts[0]);
                        y = parseInt(parts[1]);
                    }
                }

                if (!isNaN(x) && !isNaN(y)) {
                    x = Math.max(0, Math.min(x, MAP_SIZE));
                    y = Math.max(0, Math.min(y, MAP_SIZE));
                    map.flyTo([y, x], 4);
                    if (tempMarker) map.removeLayer(tempMarker);

                    tempMarker = L.marker([y, x]).addTo(map).bindPopup(`üìç Target: ${x}, ${y}`).openPopup();
                    this.blur();
                }
            }
        });

        function focarInput() {
            document.getElementById('coordInput').focus();
        }

        function toggleEditMode() {
            editMode = !editMode;
            const btn = document.getElementById('btnEditMode');
            const txt = document.getElementById('editText');

            if (editMode) {
                btn.classList.add('active');
                txt.innerText = "EDIT MODE ACTIVE";
                document.getElementById('map').style.cursor = "copy";
            } else {
                btn.classList.remove('active');
                txt.innerText = "View Mode";
                document.getElementById('map').style.cursor = "crosshair";
            }
        }

        map.on('click', function (e) {
            if (!editMode) return;

            tempClickCoords = { x: Math.round(e.latlng.lng), y: Math.round(e.latlng.lat) };
            document.getElementById('modal').style.display = 'block';
        });

        function fecharModal() {
            document.getElementById('modal').style.display = 'none';
        }

        function atualizarFormulario() {
            const tipo = document.getElementById('inputType').value;
            document.getElementById('inputName').style.display = (tipo !== 'tree' && tipo !== 'bush') ? 'block' : 'none';
            document.getElementById('selectTree').style.display = (tipo === 'tree') ? 'block' : 'none';
            document.getElementById('selectBush').style.display = (tipo === 'bush') ? 'block' : 'none';
            document.getElementById('rangeGroup').style.display = (tipo === 'tree' || tipo === 'bush') ? 'block' : 'none';
        }

        function atualizarRangeLabel(val) {
            const labels = ["Small", "Medium", "Large", "Dense", "Massive"];
            document.getElementById('rangeLabel').innerText = `${val} (${labels[val - 1]})`;
        }

        function salvarPonto() {
            const tipo = document.getElementById('inputType').value;
            let nome = (tipo === 'tree') ? document.getElementById('selectTree').value :
                (tipo === 'bush') ? document.getElementById('selectBush').value :
                    document.getElementById('inputName').value;

            if (!nome) {
                alert("Name required!");
                return;
            }

            const novoPonto = {
                cat: tipo,
                nome: nome,
                x: tempClickCoords.x,
                y: tempClickCoords.y,
                desc: document.getElementById('inputDesc').value,
                escala: (tipo === 'tree' || tipo === 'bush') ? parseInt(document.getElementById('inputRange').value) : null
            };

            dados.push(novoPonto);
            renderizarMapa();
            fecharModal();
            document.getElementById('inputName').value = "";
            document.getElementById('inputDesc').value = "";
        }

        function exportarDados() {
            console.log(JSON.stringify(dados, null, 4));
            alert("Data exported to Console (F12)!");
        }

        function toggleGroup(grupo) {
            filtrosAtivos[grupo] = !filtrosAtivos[grupo];
            renderizarMapa(document.querySelector('input[type="text"]').value);
        }

        function trocarMapa(tipo) {
            if (tipo === 'terreno') {
                map.addLayer(layerTerreno);
                map.removeLayer(layerTopo);
            } else {
                map.addLayer(layerTopo);
                map.removeLayer(layerTerreno);
            }
        }

        map.on('mousemove', e => {
            if (inputFocado) return;
            let x = Math.max(0, Math.min(Math.round(e.latlng.lng), MAP_SIZE));
            let y = Math.max(0, Math.min(Math.round(e.latlng.lat), MAP_SIZE));

            document.getElementById('coordInput').value = `${x}, ${y}`;
        });

        map.on('zoomend', function () {
            const z = map.getZoom();
            const mapDiv = document.getElementById('map');
            mapDiv.className = "";
            mapDiv.classList.add(`zoom-${z}`);
        });

        document.getElementById('map').classList.add(`zoom-${map.getZoom()}`);
        renderizarMapa();
    </script>
</body>

</html>